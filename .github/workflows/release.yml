name: Release

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: Release Version
        required: true
        default: 1.0.0
    
run-name: 'version set to ${{ github.event.inputs.releaseVersion }} for release'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: "Configure Docker: QEMU"
      uses: docker/setup-qemu-action@v2
      with:
        platforms: amd64,arm64

    - name: "Configure Docker: Buildx"
      uses: docker/setup-buildx-action@v2
      with:
        install: true

    - name: "Configure Docker: Multi-Builder Buildx"
      run: docker buildx create --use --name multi-builder --platform linux/arm64,linux/amd64

    - name: "Set Aion Version"
      run: echo AION_VERSION=${{ github.event.inputs.releaseVersion }}  >> $GITHUB_ENV

    - name: "Docker: Login"
      run: docker login ${{secrets.DOCKER_REGISTRY}} -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_PASSWORD}}

    - name: "Docker: Push Aion"
      run: |
        docker build --load -t ghcr.io/codbex/codbex-aion:${{ env.AION_VERSION }} .
        docker push ghcr.io/codbex/codbex-aion:${{ env.AION_VERSION }}

    - name: "Create Release"
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: v${{ env.AION_VERSION }}
        name: ${{ env.AION_VERSION }}
        draft: false
        prerelease: false
        files: |
          LICENSE
        body: |
          ## Codbex Aion - ${{ env.AION_VERSION }}

          Timesheets Management Application
